$(function(){loginsys()});var userinformation={"name":null,"id":null};function review(enabled){$("div.login").addClass("disable");$("div.noteview").addClass("disable");$("div.noteslist").addClass("disable");$("div."+enabled).removeClass("disable")}
function ajax_request(task,post,callback){$.post("https://notes.***REMOVED***/ajax.php?"+task,post,function(data){if(typeof data==="object"){if(data.status==='error'){console.log(data.error)}
if(typeof callback==="function"){callback(data)}}
else{alert("Connection to Server lost!!")}})}
function loginsys(){review("login");loginlocalstorage();function loginlocalstorage(){if(localStorage.getItem("userinformation_id")!=''&&localStorage.getItem("userinformation_id")!=null&&localStorage.getItem("userinformation_name")!=''&&localStorage.getItem("userinformation_name")!=null){userinformation.id=localStorage.getItem("userinformation_id");userinformation.name=localStorage.getItem("userinformation_name");$("div.login div.input div.loading").removeClass("disable");ajax_request("login",{"status":userinformation.id},function(data){$("div.login div.input div.loading").addClass("disable");if(data.data==!0){logout_enable();list()}
else{loginlink()}})}
else{loginlink()}}
function loginlink(){var code=window.location.hash;if(code!=""){code=code.substr(1);var expr=new RegExp('[a-z]+:[a-z0-9]+');if(expr.test(code)){var parts=code.split(':');var user=parts[0];var auth=parts[1];console.log('Versuche User "'+user+'" mit Loginlink einzuloggen.');$("div.login div.input div.loading").removeClass("disable");ajax_request("login",{"username":user,"authcode":auth},function(data){$("div.login div.input div.loading").addClass("disable");if(data.status==='okay'){userinformation.name=user;userinformation.id=data.data.id;localStorage.setItem("userinformation_id",userinformation.id);localStorage.setItem("userinformation_name",userinformation.name);logout_enable();list()}
else{loginform()}})}
else{loginform()}}
else{loginform()}}
function loginform(){$("div.login p.message.important").removeClass("disable");$("div.login p.message.error").addClass("disable");$("div.login p.message.okay").addClass("disable");$("div.login div.input div.loading").addClass("disable");$("div.login div.input div#loginform").removeClass("disable");$("div.login div.input").removeClass("disable");$("button#userlogin").unbind("click").click(try_login);$("input#userpassword").unbind("keyup").keyup(function(event){if(event.keyCode==13){try_login()}});function try_login(){$("div.login div.input div.loading").removeClass("disable");$("div.login div.input div#loginform").addClass("disable");$("div.login p.message.important").addClass("disable");var hashedpw=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash($("input#userpassword").val()));ajax_request("login",{"username":$("input#username").val(),"password":hashedpw},function(data){$("div.login div.input div.loading").addClass("disable");if(data.status==='error'){$("div.login p.message.error").removeClass("disable");$("div.login div.input div#loginform").removeClass("disable")}
else if(data.status==='okay'){$("div.login p.message.okay").removeClass("disable");$("div.login p.message.error").addClass("disable");$("div.login div.input").addClass("disable");$("input#username").val("");$("input#userpassword").val("");userinformation.name=data.data.name;userinformation.id=data.data.id;localStorage.setItem("userinformation_id",userinformation.id);localStorage.setItem("userinformation_name",userinformation.name);logout_enable();list()}})}}
function logout_enable(){function display_and_listen(){$("div.logout").removeClass("disable");$("button#logout").unbind("click").click(do_logout)}
function do_logout(){ajax_request("login",{"logout":null},function(data){if(data.status==='okay'){$("p.message.error.loggedout").removeClass("disable");setTimeout(function(){$("p.message.error.loggedout").addClass("disable")},20000)}});if($("input#logouttype:checked").length==0){localStorage.clear()}
else{localStorage.removeItem("userinformation_id");localStorage.removeItem("userinformation_name")}
userinformation={"name":null,"id":null};window.location.hash="";$("div.logout").addClass("disable");loginsys()}
display_and_listen()}}
function list(){review("noteslist");get_userdata();function get_userdata(){$("div.noteslist div.listpart div.loading").removeClass("disable");ajax_request("list",{"userid":userinformation.id},function(data){$("div.noteslist div.listpart div.loading").addClass("disable");if(data.status==='okay'){showlist(data.data)}})}
function showlist(notes){$("button#newnote").unbind("click").click(function(){var name=$("input#newnotename").val();if(name!=''){makenew(name)}});var table='<ul>';$.each(notes,function(k,v){table+='<li class="noteslist_notesnames box" noteid="'+v.noteid+'"><span class="notesnames">'+v.name+'</span> <span class="noteseditbuttons">'+'<button art="up" title="Nach oben" '+(k!=0?'':'disabled="disabled"')+'>&uarr;</button>'+'<button art="down" title="Nach unten" '+(notes.length-1!=k?'':'disabled="disabled"')+'>&darr;</button>'+'<button art="del" title="Löschen (macht die Notiz unsichtbar, der Admin kann sie wieder hervorzaubern)">&#x21bb;</button>'+'</span></li>'});table+='</ul>';$("div.noteslist div.listpart div.list").html(table);$("div.noteslist div.listpart div.list ul").css({"list-style-type":"none"});$("div.noteslist div.listpart div.list ul li.noteslist_notesnames").css({"line-height":"28px"});$("span.noteseditbuttons").css({"float":"right","cursor":"pointer"});$("div.noteslist div.listpart div.list ul li span.notesnames").css({"display":"inline-block","cursor":"pointer"});$("div.noteslist div.listpart div.list ul li span.notesnames").click(function(){var noteid=$(this).parent().attr("noteid");var name=$(this).text();console.log('Oeffne: "'+name+'" ("'+noteid+'")');maker(noteid,name)});$("span.noteseditbuttons button").unbind("click").click(function(){var art=$(this).attr("art");var noteid=$(this).parent().parent().attr("noteid");$("div.noteslist div.listpart div.loading").removeClass("disable");ajax_request("list",{"userid":userinformation.id,"art":art,"noteid":noteid},function(data){$("div.noteslist div.listpart div.loading").addClass("disable");if(data.status==='okay'){console.log('Notiz: "'+noteid+'" wurde '+(art=='del'?'gelöscht':(art=='up'?'nach oben verschoben':'nach unten verschoben')));list()}})})}
function makenew(name){$("div.noteslist div.listpart div.loading").removeClass("disable");ajax_request("list",{"userid":userinformation.id,"name":name},function(data){$("div.noteslist div.listpart div.loading").addClass("disable");if(data.status==='okay'){console.log('Notiz: "'+name+'" ("'+data.data.id+'") angelegt.');list()}})}}
var cm_editor;function maker(noteid,notename){review("noteview");var notedata;function get_notedata(){$("div.noteview div.loading").removeClass("disable");ajax_request("view",{"userid":userinformation.id,"noteid":noteid},function(data){$("div.noteview div.loading").addClass("disable");if(data.status==='okay'&&!data.data.empty){notedata={"name":data.data.name,"id":data.data.id,"content":data.data.content};make_inputfield()}
else{if(localStorage.getItem("note_autosave_"+noteid)!=null){notedata=JSON.parse(localStorage.getItem("note_autosave_"+noteid));make_inputfield()}
else{notedata={"name":notename,"id":noteid,"content":"# "+notename+"\nUnd hier dann der Text!!\n"};make_inputfield()}}})}
function closebutton(){$("button#closenote").unbind("click").click(function(){cm_editor.off("change",here_parser_reparse);cm_editor.off("change",here_codemi_save);ajaxsave(function(){list()})})}
var here_parser_reparse,here_codemi_save;function make_inputfield(){$("input#notename").val(notedata.name);$("textarea#notesinput").text(notedata.content);if(typeof cm_editor!=="object"){cm_editor=CodeMirror.fromTextArea(document.getElementById("notesinput"),{mode:'gfm',lineNumbers:!0,theme:"default"})}
else{cm_editor.setValue($("textarea#notesinput").val())}
load_parser_preview();autosave_changes()}
function load_parser_preview(){var markRend=new marked.Renderer();markRend.heading=function(text,level){return '<h'+(level+2)+'>'+text+'</h'+(level+2)+'>'}
markRend.link=function(href,title,text){return '<a href="'+href+'" title="'+title+'" target="_blank">'+text+'</a>'}
marked.setOptions({renderer:markRend,gfm:!0,tables:!0});function reparse(){$("div#notespreview").html(marked(cm_editor.getValue()))}
reparse();cm_editor.on("change",reparse);here_parser_reparse=reparse}
var lastajaxsave=0;function autosave_changes(){function save(){var savedata={"name":$("input#notename").val(),"id":notedata.id,"content":cm_editor.getValue()};localStorage.setItem("note_autosave_"+notedata.id,JSON.stringify(savedata));if(Date.now()-(30*1000)>lastajaxsave){ajaxsave()}}
save();cm_editor.on("change",save);here_codemi_save=save}
function ajaxsave(callback){$("div.noteview div.loading").removeClass("disable");ajax_request("view",{"userid":userinformation.id,"noteid":noteid,"note":{"name":$("input#notename").val(),"cont":cm_editor.getValue()}},function(data){$("div.noteview div.loading").addClass("disable");if(data.status==='okay'){console.log('Notiz: "'+notename+'" ("'+noteid+'") auf Server gespeichert.');lastajaxsave=Date.now();if(typeof callback==="function"){callback()}}})}
get_notedata();closebutton()}
